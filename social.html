<script>
    const polaroidContainer = document.getElementById('polaroid');

    // Effetto al click sulla polaroid
    polaroidContainer.addEventListener('click', function() {
        this.classList.add('clicked');

        setTimeout(() => {
            this.classList.remove('clicked');
        }, 200);
    });

    // Funzione per scaricare l'immagine
    function downloadImage() {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');

        // Dimensioni del canvas
        canvas.width = 400;
        canvas.height = 360; // Più alto per includere il padding della polaroid

        // Sfondo polaroid
        ctx.fillStyle = '#f5f5f5';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Bordo interno (immagine placeholder)
        const img = document.getElementById('polaroidImg');
        
        // Aspetta che l'immagine (anche se è un SVG in-page) sia "pronta"
        const tempImg = new Image();
        tempImg.onload = function() {
            ctx.drawImage(tempImg, 20, 20, 360, 240); // Disegna l'immagine

            // Testo
            ctx.fillStyle = '#333';
            ctx.font = '14px "Courier New", monospace';
            ctx.textAlign = 'center';
            ctx.fillText('VENERUS - 2024', 200, 340); // Posizione aggiustata

            // Converti in blob e scarica
            canvas.toBlob(function(blob) {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');

                // Per iOS - prova a usare il tipo MIME corretto
                if (navigator.userAgent.match(/iPhone|iPad|iPod/i)) {
                    // Su iOS, apri l'immagine in una nuova finestra
                    const newWindow = window.open('', '_blank');
                    const imgElement = new Image();
                    imgElement.onload = function() {
                        const htmlContent = `
                            <html>
                            <head>
                                <title>Polaroid VHS</title>
                                <style>
                                    body { margin: 0; padding: 20px; display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 100vh; background: #000; font-family: Helvetica, Arial, sans-serif; }
                                    img { max-width: 90vw; max-height: 60vh; height: auto; box-shadow: 0 0 20px rgba(255,255,255,0.3); border-radius: 8px; }
                                    .instruction { color: white; text-align: center; background: rgba(0,0,0,0.8); padding: 15px 20px; border-radius: 10px; margin-top: 20px; font-size: 16px; line-height: 1.4; border: 1px solid rgba(255,255,255,0.2); }
                                    @media (max-width: 480px) {
                                        body { padding: 10px; }
                                        .instruction { font-size: 14px; padding: 12px 15px; }
                                        img { max-width: 95vw; max-height: 50vh; }
                                    }
                                </style>
                            </head>
                            <body>
                                <img src="${url}" alt="Polaroid VHS" />
                                <div class="instruction">
                                    <div>Tieni premuto sull'immagine e seleziona<br><strong>"Aggiungi a Foto"</strong> per salvarla.</div>
                                </div>
                            </body>
                            </html>
                        `;
                        newWindow.document.write(htmlContent);
                        newWindow.document.close();
                    };
                    imgElement.src = url;
                } else {
                    // Per altri dispositivi, download normale
                    a.href = url;
                    a.download = 'polaroid-vhs-venerus.png';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }
            }, 'image/png'); // Chiusura della funzione toBlob e tipo MIME
        }; // <-- La parentesi grafa mancante va qui
        tempImg.src = img.src; // Imposta la sorgente per triggerare l'onload
    }
</script>